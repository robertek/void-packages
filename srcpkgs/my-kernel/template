pkgname=my-kernel
version=6.1.75
_zfs_version=2.2.2
revision=1

license="GPL-2.0-only"
maintainer="Robert David"
short_desc="Basic kernel with built-in ZFS support"
homepage="https://www.kernel.org"

# base release
distfiles="${KERNEL_SITE}/kernel/v${version%%.*}.x/linux-${version%.*}.tar.xz"
# patch release
distfiles+=" ${KERNEL_SITE}/kernel/v${version%%.*}.x/patch-${version}.xz"
# zfs
distfiles+=" https://github.com/openzfs/zfs/releases/download/zfs-${_zfs_version}/zfs-${_zfs_version}.tar.gz"
skip_extraction="patch-${version}.xz"

# base relese
checksum="2ca1f17051a430f6fed1196e4952717507171acfd97d96577212502703b25deb"
# patch release
checksum+=" 5c75fae57ee7a39549b2d642e052c0091de6b1668a845c86e3a69ddf1076c353"
# zfs
checksum+=" 76bc0547d9ba31d4b0142e417aaaf9f969072c3cb3c1a5b10c8738f39ed12fc9"

archs="x86_64*"

nodebug=yes
nostrip=yes
noverifyrdeps=yes
noshlibprovides=yes
preserve=yes

hostmakedepends="tar elfutils-devel gmp-devel kmod libmpc-devel
 openssl-devel perl uboot-mkimage cpio pahole python3 zstd base-devel
 pam-devel zlib-devel libuuid-devel libblkid-devel libtirpc-devel attr-devel
 linux-firmware-intel lz4 ncurses-devel wireless-regdb"

_kernver="${version}_${revision}"
triggers="kernel-hooks"
kernel_hooks_version="${_kernver}"

_linux_path="${XBPS_BUILDDIR}/${pkgname}-${version}/linux-${version%.*}"
_zfs_path="${XBPS_BUILDDIR}/${pkgname}-${version}/zfs-${_zfs_version}"

pre_patch() {
	cd ${_linux_path}/
	xzcat $XBPS_SRCDISTDIR/$pkgname-$version/patch-${version}.xz | patch -sNp1 -F0
}

do_configure() {
	cd ${_linux_path}/
	cp -f ${FILESDIR}/config-base .config
	make ${makejobs} olddefconfig
	make ${makejobs} prepare

	cd ${_zfs_path}
	./autogen.sh
	./configure --with-linux=${_linux_path} --with-linux-obj=${_linux_path} --enable-linux-builtin
	./copy-builtin ${_linux_path}

	cd ${_linux_path}
	cp -f ${FILESDIR}/config-base .config
	make ${makejobs} olddefconfig

	# Always use our revision to CONFIG_LOCALVERSION to match our pkg version.
	sed -i -e "s|^\(CONFIG_LOCALVERSION=\).*|\1\"_${revision}\"|" .config
}

do_build() {
	cd ${_linux_path}
	export LDFLAGS=
	make ${makejobs} bzImage modules
}

do_install() {
	vmkdir usr/lib
	ln -s usr/lib ${DESTDIR}

	cd ${_linux_path}
	make ${makejobs} INSTALL_MOD_PATH=${DESTDIR} modules_install

	rm -f ${DESTDIR}/lib

	vinstall .config 644 boot config-${_kernver}
	vinstall System.map 644 boot System.map-${_kernver}
	vinstall arch/x86/boot/bzImage 644 boot vmlinuz-${_kernver}
}
